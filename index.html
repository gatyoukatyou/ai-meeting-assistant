<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AIå‚åŠ ä¼šè­°</title>
  <style>
    :root {
      --primary: #2563eb;
      --primary-hover: #1d4ed8;
      --danger: #dc2626;
      --danger-hover: #b91c1c;
      --success: #16a34a;
      --warning: #f59e0b;
      --bg: #f8fafc;
      --card-bg: #ffffff;
      --text: #1e293b;
      --text-secondary: #64748b;
      --border: #e2e8f0;
      --shadow: 0 1px 3px rgba(0,0,0,0.1);
      --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Hiragino Sans', sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
    }

    .header {
      background: var(--card-bg);
      border-bottom: 1px solid var(--border);
      padding: 1rem 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .header h1 {
      font-size: 1.25rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .header-controls {
      display: flex;
      gap: 0.75rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .btn {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 0.5rem;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      transition: all 0.15s;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-hover);
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-danger:hover {
      background: var(--danger-hover);
    }

    .btn-secondary {
      background: var(--border);
      color: var(--text);
    }

    .btn-secondary:hover {
      background: #cbd5e1;
    }

    .btn-ghost {
      background: transparent;
      color: var(--text-secondary);
    }

    .btn-ghost:hover {
      background: var(--border);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .status-badge {
      padding: 0.25rem 0.75rem;
      border-radius: 1rem;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .status-ready {
      background: #dbeafe;
      color: #1e40af;
    }

    .status-recording {
      background: #fee2e2;
      color: #991b1b;
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    .main-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      padding: 1rem;
      max-width: 1600px;
      margin: 0 auto;
    }

    @media (max-width: 1024px) {
      .main-container {
        grid-template-columns: 1fr;
      }
    }

    .panel {
      background: var(--card-bg);
      border-radius: 0.75rem;
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .panel-header {
      padding: 1rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .panel-title {
      font-size: 1rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .panel-body {
      padding: 1rem;
      max-height: 400px;
      overflow-y: auto;
    }

    .transcript-text {
      white-space: pre-wrap;
      font-size: 0.9rem;
      line-height: 1.8;
    }

    .transcript-text:empty::before {
      content: 'éŒ²éŸ³ã‚’é–‹å§‹ã™ã‚‹ã¨ã€ã“ã“ã«æ–‡å­—èµ·ã“ã—ãŒè¡¨ç¤ºã•ã‚Œã¾ã™...';
      color: var(--text-secondary);
      font-style: italic;
    }

    .timestamp {
      color: var(--primary);
      font-weight: 500;
      font-size: 0.8rem;
    }

    /* AIè³ªå•ã‚¨ãƒªã‚¢ */
    .ai-section {
      margin-top: 1rem;
    }

    .ai-buttons {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-bottom: 1rem;
    }

    .custom-question {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .custom-question input {
      flex: 1;
      padding: 0.5rem 0.75rem;
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      font-size: 0.875rem;
    }

    .custom-question input:focus {
      outline: none;
      border-color: var(--primary);
    }

    /* ã‚¿ãƒ– */
    .tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
    }

    .tab {
      padding: 0.75rem 1rem;
      border: none;
      background: none;
      font-size: 0.875rem;
      color: var(--text-secondary);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.15s;
    }

    .tab:hover {
      color: var(--text);
    }

    .tab.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
    }

    .tab-content {
      display: none;
      padding: 1rem;
      max-height: 300px;
      overflow-y: auto;
    }

    .tab-content.active {
      display: block;
    }

    .ai-response {
      background: #f1f5f9;
      border-radius: 0.5rem;
      padding: 1rem;
      margin-bottom: 0.75rem;
      font-size: 0.9rem;
      line-height: 1.7;
    }

    .ai-response:empty::before {
      content: 'AIã«è³ªå•ã™ã‚‹ã¨ã€ã“ã“ã«å›ç­”ãŒè¡¨ç¤ºã•ã‚Œã¾ã™...';
      color: var(--text-secondary);
      font-style: italic;
    }

    .qa-item {
      margin-bottom: 1rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border);
    }

    .qa-item:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }

    .qa-question {
      font-weight: 500;
      color: var(--primary);
      margin-bottom: 0.5rem;
    }

    .qa-answer {
      background: #f1f5f9;
      border-radius: 0.5rem;
      padding: 0.75rem;
      font-size: 0.875rem;
    }

    /* ã‚³ã‚¹ãƒˆè¡¨ç¤º */
    .cost-display {
      font-size: 0.75rem;
      color: var(--text-secondary);
      padding: 0.5rem 1rem;
      background: #f8fafc;
      border-top: 1px solid var(--border);
    }

    .cost-display.expanded {
      padding: 1rem;
    }

    .cost-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.25rem;
    }

    .cost-total {
      font-weight: 600;
      color: var(--text);
      border-top: 1px solid var(--border);
      padding-top: 0.25rem;
      margin-top: 0.25rem;
    }

    .cost-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      user-select: none;
    }

    .cost-header:hover {
      color: var(--text);
    }

    .cost-details {
      display: none;
      margin-top: 0.5rem;
      padding-top: 0.5rem;
      border-top: 1px dashed var(--border);
    }

    .cost-details.show {
      display: block;
    }

    .cost-section {
      margin-bottom: 0.5rem;
    }

    .cost-section-title {
      font-weight: 500;
      color: var(--text);
      margin-bottom: 0.25rem;
      font-size: 0.7rem;
    }

    .cost-item {
      display: flex;
      justify-content: space-between;
      padding-left: 0.5rem;
      font-size: 0.7rem;
    }

    .cost-item-label {
      color: var(--text-secondary);
    }

    .cost-warning {
      background: #fef3c7;
      border: 1px solid #fde047;
      border-radius: 0.25rem;
      padding: 0.5rem;
      margin-top: 0.5rem;
      color: #92400e;
      font-size: 0.7rem;
    }

    .cost-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.125rem 0.5rem;
      border-radius: 1rem;
      font-size: 0.65rem;
      font-weight: 500;
    }

    .cost-badge-low {
      background: #d1fae5;
      color: #065f46;
    }

    .cost-badge-medium {
      background: #fef3c7;
      color: #92400e;
    }

    .cost-badge-high {
      background: #fee2e2;
      color: #991b1b;
    }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      padding: 1rem;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: var(--card-bg);
      border-radius: 0.75rem;
      max-width: 500px;
      width: 100%;
      max-height: 90vh;
      overflow: hidden;
      box-shadow: var(--shadow-lg);
    }

    .modal-header {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h2 {
      font-size: 1.125rem;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text-secondary);
      line-height: 1;
    }

    .modal-body {
      padding: 1.5rem;
      overflow-y: auto;
      max-height: calc(90vh - 140px);
    }

    .modal-footer {
      padding: 1rem 1.5rem;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: flex-end;
      gap: 0.75rem;
    }

    /* è¨­å®šãƒ•ã‚©ãƒ¼ãƒ  */
    .setting-group {
      margin-bottom: 1.25rem;
    }

    .setting-label {
      display: block;
      font-weight: 500;
      margin-bottom: 0.5rem;
      font-size: 0.875rem;
    }

    .setting-row {
      display: flex;
      gap: 0.5rem;
    }

    .setting-input {
      flex: 1;
      padding: 0.5rem 0.75rem;
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      font-size: 0.875rem;
    }

    .setting-input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .model-select {
      padding: 0.5rem;
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      font-size: 0.875rem;
      min-width: 140px;
    }

    .setting-hint {
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-top: 0.25rem;
    }

    .setting-hint a {
      color: var(--primary);
    }

    /* ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é€šçŸ¥ */
    .security-notice {
      background: #eff6ff;
      border: 1px solid #bfdbfe;
      border-radius: 0.5rem;
      padding: 1rem;
      margin-bottom: 1.25rem;
    }

    .security-notice-title {
      font-weight: 600;
      color: #1e40af;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .security-notice-text {
      font-size: 0.8rem;
      color: #1e40af;
      line-height: 1.6;
    }

    .security-features {
      margin-top: 0.75rem;
      padding-top: 0.75rem;
      border-top: 1px solid #bfdbfe;
    }

    .security-feature {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.8rem;
      color: #1e40af;
      margin-bottom: 0.25rem;
    }

    .security-feature::before {
      content: 'âœ“';
      color: var(--success);
      font-weight: bold;
    }

    /* ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚ªãƒ—ã‚·ãƒ§ãƒ³ */
    .security-options {
      background: #fefce8;
      border: 1px solid #fde047;
      border-radius: 0.5rem;
      padding: 1rem;
      margin-top: 1.25rem;
    }

    .security-options-title {
      font-weight: 600;
      color: #854d0e;
      margin-bottom: 0.75rem;
      font-size: 0.875rem;
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .checkbox-group input[type="checkbox"] {
      width: 1rem;
      height: 1rem;
    }

    .checkbox-group label {
      font-size: 0.8rem;
      color: #854d0e;
    }

    /* æ¤œè¨¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ */
    .validation-status {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      font-size: 0.7rem;
      padding: 0.125rem 0.5rem;
      border-radius: 1rem;
      margin-left: 0.5rem;
    }

    .validation-pending {
      background: #fef3c7;
      color: #92400e;
    }

    .validation-success {
      background: #d1fae5;
      color: #065f46;
    }

    .validation-error {
      background: #fee2e2;
      color: #991b1b;
    }

    /* ã‚¦ã‚§ãƒ«ã‚«ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .welcome-content {
      text-align: center;
      padding: 1rem 0;
    }

    .welcome-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
    }

    .welcome-title {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .welcome-desc {
      color: var(--text-secondary);
      margin-bottom: 1.5rem;
    }

    .welcome-features {
      text-align: left;
      background: #f8fafc;
      border-radius: 0.5rem;
      padding: 1rem;
      margin-bottom: 1.5rem;
    }

    .welcome-feature {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }

    .welcome-feature:last-child {
      margin-bottom: 0;
    }

    .welcome-feature-icon {
      font-size: 1.25rem;
    }

    .welcome-feature-text {
      font-size: 0.875rem;
    }

    .welcome-btn {
      width: 100%;
      padding: 0.75rem;
      font-size: 1rem;
    }

    /* ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« */
    .export-preview {
      background: #1e293b;
      color: #e2e8f0;
      border-radius: 0.5rem;
      padding: 1rem;
      font-family: monospace;
      font-size: 0.75rem;
      max-height: 300px;
      overflow-y: auto;
      white-space: pre-wrap;
    }

    /* è¨­å®šã‚¤ãƒ³ãƒãƒ¼ãƒˆ/ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ */
    .settings-transfer {
      margin-top: 1.5rem;
      padding-top: 1.5rem;
      border-top: 1px solid var(--border);
    }

    .settings-transfer-title {
      font-weight: 600;
      margin-bottom: 0.75rem;
      font-size: 0.875rem;
    }

    .settings-transfer-buttons {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .settings-transfer-hint {
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-top: 0.5rem;
    }

    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
    @media (max-width: 640px) {
      .header {
        padding: 0.75rem 1rem;
      }

      .header h1 {
        font-size: 1rem;
      }

      .btn {
        padding: 0.4rem 0.75rem;
        font-size: 0.8rem;
      }

      .main-container {
        padding: 0.75rem;
      }
    }

    /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
    .loading {
      display: inline-block;
      width: 1rem;
      height: 1rem;
      border: 2px solid #e2e8f0;
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* LLMã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ */
    .llm-indicator {
      padding: 0.25rem 0.75rem;
      border-radius: 1rem;
      font-size: 0.75rem;
      font-weight: 500;
      background: #dbeafe;
      color: #1e40af;
    }

    .llm-indicator.no-api {
      background: #fee2e2;
      color: #991b1b;
    }
  </style>
</head>
<body>
  <header class="header">
    <h1>ğŸ¤– AIå‚åŠ ä¼šè­°</h1>
    <div class="header-controls">
      <span class="status-badge status-ready" id="statusBadge">â¸ å¾…æ©Ÿä¸­</span>
      <select id="transcriptProvider" class="model-select" style="min-width: 110px;" title="æ–‡å­—èµ·ã“ã—API">
        <option value="gemini">ğŸ¤ Gemini</option>
        <option value="openai">ğŸ¤ OpenAI</option>
      </select>
      <select id="transcriptInterval" class="model-select" style="min-width: 80px;">
        <option value="15">15ç§’</option>
        <option value="30" selected>30ç§’</option>
        <option value="60">60ç§’</option>
        <option value="120">2åˆ†</option>
      </select>
      <button class="btn btn-primary" id="recordBtn" onclick="toggleRecording()">ğŸ¤ éŒ²éŸ³é–‹å§‹</button>
      <button class="btn btn-secondary" onclick="openExportModal()">ğŸ“¥ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
      <button class="btn btn-ghost" onclick="openSettings()">âš™ï¸ è¨­å®š</button>
    </div>
  </header>

  <main class="main-container">
    <!-- æ–‡å­—èµ·ã“ã—ãƒ‘ãƒãƒ« -->
    <div class="panel">
      <div class="panel-header">
        <span class="panel-title">ğŸ“ æ–‡å­—èµ·ã“ã—</span>
        <button class="btn btn-ghost" onclick="clearTranscript()" style="font-size: 0.75rem;">ã‚¯ãƒªã‚¢</button>
      </div>
      <div class="panel-body" id="transcriptBody">
        <div class="transcript-text" id="transcriptText"></div>
      </div>
      <div class="cost-display" id="transcriptCostPanel">
        <div class="cost-header" onclick="toggleCostDetails('transcript')">
          <span>ğŸ’° æ–‡å­—èµ·ã“ã—ã‚³ã‚¹ãƒˆ</span>
          <span><span id="transcriptCostTotal">Â¥0</span> <span id="transcriptCostBadge" class="cost-badge cost-badge-low">ä½</span></span>
        </div>
        <div class="cost-details" id="transcriptCostDetails">
          <div class="cost-section">
            <div class="cost-section-title">ğŸ“Š ä½¿ç”¨é‡</div>
            <div class="cost-item">
              <span class="cost-item-label">å‡¦ç†æ™‚é–“:</span>
              <span id="transcriptDuration">0ç§’</span>
            </div>
            <div class="cost-item">
              <span class="cost-item-label">APIå‘¼ã³å‡ºã—:</span>
              <span id="transcriptCalls">0å›</span>
            </div>
          </div>
          <div class="cost-section">
            <div class="cost-section-title">ğŸ’µ ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼åˆ¥</div>
            <div class="cost-item">
              <span class="cost-item-label">Gemini Audio:</span>
              <span id="geminiTranscriptCost">Â¥0</span>
            </div>
            <div class="cost-item">
              <span class="cost-item-label">OpenAI Whisper:</span>
              <span id="openaiTranscriptCost">Â¥0</span>
            </div>
          </div>
          <div class="cost-section">
            <div class="cost-section-title">ğŸ“ˆ ãƒ¬ãƒ¼ãƒˆ</div>
            <div class="cost-item">
              <span class="cost-item-label">Gemini:</span>
              <span>Â¥0.0015/ç§’</span>
            </div>
            <div class="cost-item">
              <span class="cost-item-label">Whisper:</span>
              <span>Â¥0.9/åˆ†</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- AIãƒ‘ãƒãƒ« -->
    <div class="panel">
      <div class="panel-header">
        <span class="panel-title">ğŸ’¬ AIå›ç­”</span>
        <span class="llm-indicator" id="llmIndicator" title="ä½¿ç”¨ä¸­ã®LLM">ğŸ¤– æœªè¨­å®š</span>
      </div>
      
      <div class="ai-section" style="padding: 1rem; padding-bottom: 0;">
        <div class="ai-buttons">
          <button class="btn btn-primary" onclick="askAI('summary')">ğŸ“‹ è¦ç´„</button>
          <button class="btn btn-secondary" onclick="askAI('opinion')">ğŸ’­ æ„è¦‹ã‚’èã</button>
          <button class="btn btn-secondary" onclick="askAI('idea')">ğŸ’¡ ã‚¢ã‚¤ãƒ‡ã‚¢</button>
        </div>
        <div class="custom-question">
          <input type="text" id="customQuestion" placeholder="è‡ªç”±ã«è³ªå•..." onkeypress="if(event.key==='Enter')askAI('custom')">
          <button class="btn btn-primary" onclick="askAI('custom')">é€ä¿¡</button>
        </div>
      </div>

      <div class="tabs">
        <button class="tab active" data-tab="summary" onclick="switchTab('summary')">è¦ç´„</button>
        <button class="tab" data-tab="opinion" onclick="switchTab('opinion')">æ„è¦‹</button>
        <button class="tab" data-tab="idea" onclick="switchTab('idea')">ã‚¢ã‚¤ãƒ‡ã‚¢</button>
        <button class="tab" data-tab="custom" onclick="switchTab('custom')">Q&A</button>
      </div>

      <div class="tab-content active" id="tab-summary">
        <div class="ai-response" id="response-summary"></div>
      </div>
      <div class="tab-content" id="tab-opinion">
        <div class="ai-response" id="response-opinion"></div>
      </div>
      <div class="tab-content" id="tab-idea">
        <div class="ai-response" id="response-idea"></div>
      </div>
      <div class="tab-content" id="tab-custom">
        <div id="qa-history"></div>
      </div>

      <div class="cost-display" id="llmCostPanel">
        <div class="cost-header" onclick="toggleCostDetails('llm')">
          <span>ğŸ’° LLMã‚³ã‚¹ãƒˆ</span>
          <span><span id="llmCostTotal">Â¥0</span> <span id="llmCostBadge" class="cost-badge cost-badge-low">ä½</span></span>
        </div>
        <div class="cost-details" id="llmCostDetails">
          <div class="cost-section">
            <div class="cost-section-title">ğŸ“Š ä½¿ç”¨é‡</div>
            <div class="cost-item">
              <span class="cost-item-label">å…¥åŠ›ãƒˆãƒ¼ã‚¯ãƒ³:</span>
              <span id="llmInputTokens">0</span>
            </div>
            <div class="cost-item">
              <span class="cost-item-label">å‡ºåŠ›ãƒˆãƒ¼ã‚¯ãƒ³:</span>
              <span id="llmOutputTokens">0</span>
            </div>
            <div class="cost-item">
              <span class="cost-item-label">APIå‘¼ã³å‡ºã—:</span>
              <span id="llmCalls">0å›</span>
            </div>
          </div>
          <div class="cost-section">
            <div class="cost-section-title">ğŸ’µ ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼åˆ¥</div>
            <div class="cost-item">
              <span class="cost-item-label">Gemini:</span>
              <span id="geminiLlmCost">Â¥0</span>
            </div>
            <div class="cost-item">
              <span class="cost-item-label">Claude:</span>
              <span id="claudeCost">Â¥0</span>
            </div>
            <div class="cost-item">
              <span class="cost-item-label">OpenAI:</span>
              <span id="openaiCost">Â¥0</span>
            </div>
            <div class="cost-item">
              <span class="cost-item-label">Groq:</span>
              <span id="groqCost">Â¥0</span>
            </div>
          </div>
        </div>
        <div class="cost-row cost-total" style="margin-top: 0.5rem;">
          <span>ğŸ“Š åˆè¨ˆæ¦‚ç®—:</span>
          <span id="totalCost">Â¥0</span>
        </div>
        <div id="costWarning" class="cost-warning" style="display: none;">
          âš ï¸ è¨­å®šã—ãŸä¸Šé™ã«è¿‘ã¥ã„ã¦ã„ã¾ã™
        </div>
      </div>
    </div>
  </main>

  <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
  <footer style="text-align: center; padding: 1rem; font-size: 0.75rem; color: var(--text-secondary); border-top: 1px solid var(--border); background: var(--card-bg);">
    <div style="display: flex; justify-content: center; gap: 1.5rem; flex-wrap: wrap;">
      <a href="docs/TERMS.md" target="_blank" style="color: var(--text-secondary); text-decoration: none;">åˆ©ç”¨è¦ç´„</a>
      <a href="docs/PRIVACY.md" target="_blank" style="color: var(--text-secondary); text-decoration: none;">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a>
      <a href="docs/SECURITY.md" target="_blank" style="color: var(--text-secondary); text-decoration: none;">ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£</a>
      <a href="https://github.com/gatyoukatyou/ai-meeting-assistant" target="_blank" rel="noopener" style="color: var(--text-secondary); text-decoration: none;">GitHub</a>
    </div>
    <div style="margin-top: 0.5rem;">
      Â© 2024 AIå‚åŠ ä¼šè­° | MITãƒ©ã‚¤ã‚»ãƒ³ã‚¹
    </div>
  </footer>

  <!-- ã‚¦ã‚§ãƒ«ã‚«ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal-overlay" id="welcomeModal">
    <div class="modal">
      <div class="modal-body">
        <div class="welcome-content">
          <div class="welcome-icon">ğŸ¤–</div>
          <h2 class="welcome-title">AIå‚åŠ ä¼šè­°ã¸ã‚ˆã†ã“ã</h2>
          <p class="welcome-desc">ä¼šè­°ä¸­ã«AIãŒãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§å‚åŠ ã—ã€<br>æ–‡å­—èµ·ã“ã—ãƒ»è¦ç´„ãƒ»æ„è¦‹ãƒ»ã‚¢ã‚¤ãƒ‡ã‚¢ææ¡ˆã‚’è¡Œã„ã¾ã™</p>
          
          <div class="welcome-features">
            <div class="welcome-feature">
              <span class="welcome-feature-icon">ğŸ¤</span>
              <span class="welcome-feature-text">é«˜ç²¾åº¦ãªéŸ³å£°æ–‡å­—èµ·ã“ã—ï¼ˆGemini Audioï¼‰</span>
            </div>
            <div class="welcome-feature">
              <span class="welcome-feature-icon">ğŸ§ </span>
              <span class="welcome-feature-text">è¤‡æ•°ã®AIãƒ¢ãƒ‡ãƒ«ã«å¯¾å¿œ</span>
            </div>
            <div class="welcome-feature">
              <span class="welcome-feature-icon">ğŸ”’</span>
              <span class="welcome-feature-text">APIã‚­ãƒ¼ã¯æš—å·åŒ–ã—ã¦ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜</span>
            </div>
            <div class="welcome-feature">
              <span class="welcome-feature-icon">ğŸ’°</span>
              <span class="welcome-feature-text">åˆ©ç”¨æ–™é‡‘ã®æ¦‚ç®—ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤º</span>
            </div>
          </div>

          <button class="btn btn-primary welcome-btn" onclick="closeWelcome(); openSettings();">
            âš™ï¸ è¨­å®šã‚’é–‹å§‹ã™ã‚‹
          </button>
          
          <div style="margin-top: 1rem; font-size: 0.75rem; color: var(--text-secondary); text-align: center;">
            åˆ©ç”¨é–‹å§‹ã«ã‚ˆã‚Šã€<a href="docs/TERMS.md" target="_blank" style="color: var(--primary);">åˆ©ç”¨è¦ç´„</a>ã¨<a href="docs/PRIVACY.md" target="_blank" style="color: var(--primary);">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a>ã«åŒæ„ã—ãŸã‚‚ã®ã¨ã¿ãªã•ã‚Œã¾ã™ã€‚
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal-overlay" id="settingsModal">
    <div class="modal" style="max-width: 550px;">
      <div class="modal-header">
        <h2>âš™ï¸ è¨­å®š</h2>
        <button class="modal-close" onclick="closeSettings()">Ã—</button>
      </div>
      <div class="modal-body">
        <div class="security-notice">
          <div class="security-notice-title">
            <span>ğŸ”’</span>
            <span>APIã‚­ãƒ¼ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£</span>
          </div>
          <div class="security-notice-text">
            APIã‚­ãƒ¼ã¯ã“ã®ã‚¢ãƒ—ãƒªå†…ã§æš—å·åŒ–ã•ã‚Œã€ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚
            å¤–éƒ¨ã‚µãƒ¼ãƒãƒ¼ã«ã¯ä¸€åˆ‡é€ä¿¡ã•ã‚Œã¾ã›ã‚“ã€‚
          </div>
          <div class="security-features">
            <div class="security-feature">æš—å·åŒ–ã—ã¦ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ï¼ˆå¹³æ–‡ã§ã¯ä¿å­˜ã—ãªã„ï¼‰</div>
            <div class="security-feature">APIå‘¼ã³å‡ºã—æ™‚ã®ã¿HTTPSçµŒç”±ã§é€ä¿¡</div>
            <div class="security-feature">ä»–ã®Webã‚µã‚¤ãƒˆã‹ã‚‰ã¯ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯</div>
            <div class="security-feature">è¨­å®šã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ/ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¯¾å¿œ</div>
          </div>
        </div>

        <!-- æ–‡å­—èµ·ã“ã—ç”¨API -->
        <div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem;">
          <div style="font-weight: 600; color: #166534; margin-bottom: 0.75rem;">ğŸ¤ æ–‡å­—èµ·ã“ã—ç”¨APIï¼ˆã„ãšã‚Œã‹1ã¤å¿…é ˆï¼‰</div>
          
          <div class="setting-group" style="margin-bottom: 0.75rem;">
            <label class="setting-label">
              Gemini API
              <span class="validation-status validation-pending" id="gemini-status" style="display:none;"></span>
            </label>
            <div class="setting-row">
              <input type="password" class="setting-input" id="geminiApiKey" placeholder="AIza...">
              <select class="model-select" id="geminiModel">
                <option value="gemini-2.0-flash-exp">gemini-2.0-flash</option>
                <option value="gemini-1.5-pro">gemini-1.5-pro</option>
                <option value="gemini-1.5-flash">gemini-1.5-flash</option>
              </select>
            </div>
            <div class="setting-hint">
              <a href="https://aistudio.google.com/apikey" target="_blank" rel="noopener">Google AI Studio</a> ã‹ã‚‰å–å¾—ï¼ˆæ–‡å­—èµ·ã“ã—ï¼†LLMä¸¡æ–¹ã«ä½¿ç”¨å¯èƒ½ï¼‰
            </div>
          </div>

          <div class="setting-group" style="margin-bottom: 0;">
            <label class="setting-label">
              OpenAI APIï¼ˆWhisperï¼‰
              <span class="validation-status" id="openai-status" style="display:none;"></span>
            </label>
            <div class="setting-row">
              <input type="password" class="setting-input" id="openaiApiKey" placeholder="sk-...">
              <select class="model-select" id="openaiModel">
                <option value="gpt-4o">gpt-4o</option>
                <option value="gpt-4o-mini">gpt-4o-mini</option>
              </select>
            </div>
            <div class="setting-hint">
              <a href="https://platform.openai.com/api-keys" target="_blank" rel="noopener">OpenAI Platform</a> ã‹ã‚‰å–å¾—ï¼ˆWhisperæ–‡å­—èµ·ã“ã—ï¼†LLMä¸¡æ–¹ã«ä½¿ç”¨å¯èƒ½ï¼‰
            </div>
          </div>
        </div>

        <!-- LLMå°‚ç”¨API -->
        <div style="background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem;">
          <div style="font-weight: 600; color: #1e40af; margin-bottom: 0.75rem;">ğŸ’¬ LLMå°‚ç”¨APIï¼ˆä»»æ„ãƒ»è¿½åŠ ã®AIãƒ¢ãƒ‡ãƒ«ï¼‰</div>
          
          <div class="setting-group" style="margin-bottom: 0.75rem;">
            <label class="setting-label">
              Claude API
              <span class="validation-status" id="claude-status" style="display:none;"></span>
            </label>
            <div class="setting-row">
              <input type="password" class="setting-input" id="claudeApiKey" placeholder="sk-ant-...">
              <select class="model-select" id="claudeModel">
                <option value="claude-sonnet-4-20250514">claude-sonnet-4</option>
                <option value="claude-3-5-sonnet-20241022">claude-3.5-sonnet</option>
              </select>
            </div>
            <div class="setting-hint">
              <a href="https://console.anthropic.com/" target="_blank" rel="noopener">Anthropic Console</a> ã‹ã‚‰å–å¾—
            </div>
          </div>

          <div class="setting-group" style="margin-bottom: 0;">
            <label class="setting-label">
              Groq API
              <span class="validation-status" id="groq-status" style="display:none;"></span>
            </label>
            <div class="setting-row">
              <input type="password" class="setting-input" id="groqApiKey" placeholder="gsk_...">
              <select class="model-select" id="groqModel">
                <option value="llama-3.1-70b-versatile">llama-3.1-70b</option>
                <option value="llama-3.1-8b-instant">llama-3.1-8b</option>
              </select>
            </div>
            <div class="setting-hint">
              <a href="https://console.groq.com/keys" target="_blank" rel="noopener">Groq Console</a> ã‹ã‚‰å–å¾—ï¼ˆé«˜é€Ÿãƒ»ä½ã‚³ã‚¹ãƒˆï¼‰
            </div>
          </div>
        </div>

        <!-- LLMå„ªå…ˆé †ä½ -->
        <div class="setting-group">
          <label class="setting-label">ğŸ’¬ LLMå„ªå…ˆé †ä½</label>
          <select class="model-select" id="llmPriority" style="width: 100%;">
            <option value="auto">è‡ªå‹•é¸æŠï¼ˆè¨­å®šã•ã‚ŒãŸAPIã‚’é †ã«ä½¿ç”¨ï¼‰</option>
            <option value="gemini">Gemini ã‚’å„ªå…ˆ</option>
            <option value="claude">Claude ã‚’å„ªå…ˆ</option>
            <option value="openai">OpenAI ã‚’å„ªå…ˆ</option>
            <option value="groq">Groq ã‚’å„ªå…ˆ</option>
          </select>
          <div class="setting-hint">
            è‡ªå‹•é¸æŠã®å ´åˆ: Claude â†’ OpenAI â†’ Gemini â†’ Groq ã®é †ã§ã€APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‚‚ã®ã‚’ä½¿ç”¨
          </div>
        </div>

        <div class="security-options">
          <div class="security-options-title">ğŸ›¡ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚ªãƒ—ã‚·ãƒ§ãƒ³</div>
          <div class="checkbox-group">
            <input type="checkbox" id="clearOnClose">
            <label for="clearOnClose">ãƒ–ãƒ©ã‚¦ã‚¶ã‚’é–‰ã˜ãŸã‚‰APIã‚­ãƒ¼ã‚’è‡ªå‹•å‰Šé™¤ï¼ˆå…±æœ‰PCå‘ã‘ï¼‰</label>
          </div>
        </div>

        <div class="security-options" style="background: #eff6ff; border-color: #bfdbfe;">
          <div class="security-options-title" style="color: #1e40af;">ğŸ’° ã‚³ã‚¹ãƒˆã‚¢ãƒ©ãƒ¼ãƒˆ</div>
          <div class="setting-group" style="margin-bottom: 0.5rem;">
            <label class="setting-label" style="font-size: 0.8rem;">1ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ä¸Šé™é‡‘é¡ï¼ˆå††ï¼‰</label>
            <input type="number" class="setting-input" id="costLimit" placeholder="ä¾‹: 100" value="100" min="0" step="10" style="max-width: 150px;">
          </div>
          <div class="checkbox-group">
            <input type="checkbox" id="costAlertEnabled" checked>
            <label for="costAlertEnabled" style="color: #1e40af;">ä¸Šé™ã®80%ã§è­¦å‘Šã‚’è¡¨ç¤º</label>
          </div>
        </div>

        <div class="settings-transfer">
          <div class="settings-transfer-title">ğŸ“¦ è¨­å®šã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</div>
          <div class="settings-transfer-buttons">
            <button class="btn btn-secondary" onclick="exportSettings()">ğŸ“¤ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
            <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">ğŸ“¥ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
            <input type="file" id="importFile" accept=".json" style="display:none;" onchange="importSettings(event)">
            <button class="btn btn-danger" onclick="clearAllSettings()">ğŸ—‘ï¸ å…¨å‰Šé™¤</button>
          </div>
          <div class="settings-transfer-hint">
            ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã¯æš—å·åŒ–ã•ã‚Œã¦ã„ã¾ã™ã€‚ä»–ã®ãƒ‡ãƒã‚¤ã‚¹ã¸ã®ç§»è¡Œã«ä½¿ç”¨ã§ãã¾ã™ã€‚
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeSettings()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn btn-primary" onclick="saveSettings()">ğŸ’¾ ä¿å­˜</button>
      </div>
    </div>
  </div>

  <!-- ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal-overlay" id="exportModal">
    <div class="modal" style="max-width: 700px;">
      <div class="modal-header">
        <h2>ğŸ“¥ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</h2>
        <button class="modal-close" onclick="closeExportModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <div class="setting-group">
          <label class="setting-label">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</label>
          <div class="export-preview" id="exportPreview"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeExportModal()">é–‰ã˜ã‚‹</button>
        <button class="btn btn-primary" onclick="downloadExport()">ğŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
      </div>
    </div>
  </div>

  <script>
    // =====================================
    // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ï¼šæš—å·åŒ–ãƒ»å¾©å·åŒ–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
    // =====================================
    const SecureStorage = {
      // ãƒ‡ãƒã‚¤ã‚¹å›ºæœ‰ã®ã‚­ãƒ¼ã‚’ç”Ÿæˆï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ãƒ•ã‚£ãƒ³ã‚¬ãƒ¼ãƒ—ãƒªãƒ³ãƒˆçš„ãªã‚‚ã®ï¼‰
      _getDeviceKey: function() {
        let deviceKey = localStorage.getItem('_dk');
        if (!deviceKey) {
          // ãƒ©ãƒ³ãƒ€ãƒ ãªãƒ‡ãƒã‚¤ã‚¹ã‚­ãƒ¼ã‚’ç”Ÿæˆ
          deviceKey = this._generateRandomKey();
          localStorage.setItem('_dk', deviceKey);
        }
        return deviceKey;
      },

      _generateRandomKey: function() {
        const array = new Uint8Array(32);
        crypto.getRandomValues(array);
        return Array.from(array, b => b.toString(16).padStart(2, '0')).join('');
      },

      // ç°¡æ˜“æš—å·åŒ–ï¼ˆXOR + Base64ï¼‰
      _encrypt: function(text) {
        if (!text) return '';
        const key = this._getDeviceKey();
        let result = '';
        for (let i = 0; i < text.length; i++) {
          result += String.fromCharCode(
            text.charCodeAt(i) ^ key.charCodeAt(i % key.length)
          );
        }
        return btoa(unescape(encodeURIComponent(result)));
      },

      _decrypt: function(encoded) {
        if (!encoded) return '';
        try {
          const key = this._getDeviceKey();
          const text = decodeURIComponent(escape(atob(encoded)));
          let result = '';
          for (let i = 0; i < text.length; i++) {
            result += String.fromCharCode(
              text.charCodeAt(i) ^ key.charCodeAt(i % key.length)
            );
          }
          return result;
        } catch (e) {
          console.error('Decryption failed:', e);
          return '';
        }
      },

      // APIã‚­ãƒ¼ã‚’ä¿å­˜
      setApiKey: function(provider, key) {
        if (!key) {
          localStorage.removeItem(`_ak_${provider}`);
          return;
        }
        localStorage.setItem(`_ak_${provider}`, this._encrypt(key));
      },

      // APIã‚­ãƒ¼ã‚’å–å¾—
      getApiKey: function(provider) {
        const encrypted = localStorage.getItem(`_ak_${provider}`);
        return this._decrypt(encrypted);
      },

      // ãƒ¢ãƒ‡ãƒ«ã‚’ä¿å­˜ï¼ˆæš—å·åŒ–ä¸è¦ï¼‰
      setModel: function(provider, model) {
        localStorage.setItem(`_m_${provider}`, model);
      },

      getModel: function(provider) {
        return localStorage.getItem(`_m_${provider}`);
      },

      // ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä¿å­˜
      setOption: function(key, value) {
        localStorage.setItem(`_opt_${key}`, JSON.stringify(value));
      },

      getOption: function(key, defaultValue) {
        const val = localStorage.getItem(`_opt_${key}`);
        return val ? JSON.parse(val) : defaultValue;
      },

      // å…¨è¨­å®šã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆåˆ¥ã®ãƒ‡ãƒã‚¤ã‚¹ç”¨ã«å†æš—å·åŒ–ï¼‰
      exportAll: function(exportPassword) {
        const data = {
          gemini: { key: this.getApiKey('gemini'), model: this.getModel('gemini') },
          claude: { key: this.getApiKey('claude'), model: this.getModel('claude') },
          openai: { key: this.getApiKey('openai'), model: this.getModel('openai') },
          groq: { key: this.getApiKey('groq'), model: this.getModel('groq') },
          options: {
            clearOnClose: this.getOption('clearOnClose', false)
          },
          exportedAt: new Date().toISOString()
        };
        
        // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆç”¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§æš—å·åŒ–
        const json = JSON.stringify(data);
        let encrypted = '';
        for (let i = 0; i < json.length; i++) {
          encrypted += String.fromCharCode(
            json.charCodeAt(i) ^ exportPassword.charCodeAt(i % exportPassword.length)
          );
        }
        return btoa(unescape(encodeURIComponent(encrypted)));
      },

      // ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
      importAll: function(encryptedData, importPassword) {
        try {
          const decoded = decodeURIComponent(escape(atob(encryptedData)));
          let json = '';
          for (let i = 0; i < decoded.length; i++) {
            json += String.fromCharCode(
              decoded.charCodeAt(i) ^ importPassword.charCodeAt(i % importPassword.length)
            );
          }
          const data = JSON.parse(json);
          
          if (data.gemini?.key) this.setApiKey('gemini', data.gemini.key);
          if (data.gemini?.model) this.setModel('gemini', data.gemini.model);
          if (data.claude?.key) this.setApiKey('claude', data.claude.key);
          if (data.claude?.model) this.setModel('claude', data.claude.model);
          if (data.openai?.key) this.setApiKey('openai', data.openai.key);
          if (data.openai?.model) this.setModel('openai', data.openai.model);
          if (data.groq?.key) this.setApiKey('groq', data.groq.key);
          if (data.groq?.model) this.setModel('groq', data.groq.model);
          if (data.options) {
            this.setOption('clearOnClose', data.options.clearOnClose || false);
          }
          
          return true;
        } catch (e) {
          console.error('Import failed:', e);
          return false;
        }
      },

      // å…¨å‰Šé™¤
      clearAll: function() {
        ['gemini', 'claude', 'openai', 'groq'].forEach(p => {
          localStorage.removeItem(`_ak_${p}`);
          localStorage.removeItem(`_m_${p}`);
        });
        localStorage.removeItem('_opt_clearOnClose');
      },

      // APIã‚­ãƒ¼ã®ã¿å‰Šé™¤ï¼ˆãƒ‡ãƒã‚¤ã‚¹ã‚­ãƒ¼ã¯æ®‹ã™ï¼‰
      clearApiKeys: function() {
        ['gemini', 'claude', 'openai', 'groq'].forEach(p => {
          localStorage.removeItem(`_ak_${p}`);
        });
      }
    };

    // =====================================
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    // =====================================
    let isRecording = false;
    let mediaRecorder = null;
    let audioChunks = [];
    let transcriptIntervalId = null;
    let fullTranscript = '';
    
    // ã‚³ã‚¹ãƒˆç®¡ç†ï¼ˆè©³ç´°ç‰ˆï¼‰
    let costs = {
      transcript: {
        total: 0,
        duration: 0,      // å‡¦ç†ã—ãŸéŸ³å£°ã®ç§’æ•°
        calls: 0,         // APIå‘¼ã³å‡ºã—å›æ•°
        byProvider: {
          gemini: 0,
          openai: 0
        }
      },
      llm: {
        total: 0,
        inputTokens: 0,
        outputTokens: 0,
        calls: 0,
        byProvider: {
          gemini: 0,
          claude: 0,
          openai: 0,
          groq: 0
        }
      }
    };

    // æ–™é‡‘ãƒ¬ãƒ¼ãƒˆï¼ˆ2024å¹´12æœˆæ™‚ç‚¹ã€1ãƒ‰ãƒ«=150å††æ›ç®—ï¼‰
    const PRICING = {
      // æ–‡å­—èµ·ã“ã—API
      transcription: {
        gemini: {
          // Gemini 2.0 Flash - Audio input: $0.00001/second
          perSecond: 0.00001 * 150  // Â¥0.0015/ç§’
        },
        openai: {
          // Whisper - $0.006/minute
          perMinute: 0.006 * 150  // Â¥0.9/åˆ†
        }
      },
      // LLMæ–™é‡‘ï¼ˆ$/1M tokensï¼‰
      gemini: {
        'gemini-2.0-flash-exp': { input: 0.075, output: 0.3 },
        'gemini-1.5-pro': { input: 1.25, output: 5.0 },
        'gemini-1.5-flash': { input: 0.075, output: 0.3 }
      },
      claude: {
        'claude-sonnet-4-20250514': { input: 3, output: 15 },
        'claude-3-5-sonnet-20241022': { input: 3, output: 15 }
      },
      openai: {
        'gpt-4o': { input: 2.5, output: 10 },
        'gpt-4o-mini': { input: 0.15, output: 0.6 }
      },
      groq: {
        'llama-3.1-70b-versatile': { input: 0.59, output: 0.79 },
        'llama-3.1-8b-instant': { input: 0.05, output: 0.08 }
      },
      yenPerDollar: 150
    };

    // AIå›ç­”ã®å±¥æ­´
    let aiResponses = {
      summary: '',
      opinion: '',
      idea: '',
      custom: [] // Q&Aå½¢å¼ã§è“„ç©
    };

    // =====================================
    // åˆæœŸåŒ–
    // =====================================
    document.addEventListener('DOMContentLoaded', function() {
      // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼šãƒ–ãƒ©ã‚¦ã‚¶ã‚’é–‰ã˜ãŸã‚‰ã‚¯ãƒªã‚¢
      if (SecureStorage.getOption('clearOnClose', false)) {
        // sessionStorageã«ãƒ•ãƒ©ã‚°ãŒãªã‘ã‚Œã°ã€æ–°ã—ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³
        if (!sessionStorage.getItem('_session_active')) {
          SecureStorage.clearApiKeys();
        }
      }
      sessionStorage.setItem('_session_active', 'true');

      // åˆå›è¨ªå•ãƒã‚§ãƒƒã‚¯
      const hasVisited = localStorage.getItem('_visited');
      if (!hasVisited) {
        document.getElementById('welcomeModal').classList.add('active');
        localStorage.setItem('_visited', 'true');
      }

      // ä¿å­˜ã•ã‚ŒãŸè¨­å®šã‚’å¾©å…ƒ
      loadSavedSettings();

      // ãƒ–ãƒ©ã‚¦ã‚¶ã‚’é–‰ã˜ã‚‹å‰ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
      window.addEventListener('beforeunload', function() {
        if (SecureStorage.getOption('clearOnClose', false)) {
          SecureStorage.clearApiKeys();
        }
      });
    });

    function loadSavedSettings() {
      // APIã‚­ãƒ¼ã‚’å…¥åŠ›æ¬„ã«å¾©å…ƒï¼ˆãƒã‚¹ã‚¯è¡¨ç¤ºã®ãŸã‚å®Ÿéš›ã«ã¯è¡¨ç¤ºã•ã‚Œãªã„ãŒã€å€¤ã¨ã—ã¦ã¯å­˜åœ¨ï¼‰
      const providers = ['gemini', 'claude', 'openai', 'groq'];
      providers.forEach(p => {
        const key = SecureStorage.getApiKey(p);
        const model = SecureStorage.getModel(p);
        if (key) document.getElementById(`${p}ApiKey`).value = key;
        if (model) document.getElementById(`${p}Model`).value = model;
      });

      // ã‚ªãƒ—ã‚·ãƒ§ãƒ³
      document.getElementById('clearOnClose').checked = SecureStorage.getOption('clearOnClose', false);
      document.getElementById('costAlertEnabled').checked = SecureStorage.getOption('costAlertEnabled', true);
      document.getElementById('costLimit').value = SecureStorage.getOption('costLimit', 100);
      document.getElementById('llmPriority').value = SecureStorage.getOption('llmPriority', 'auto');
      
      // æ–‡å­—èµ·ã“ã—ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®é¸æŠã‚’æ›´æ–°
      updateTranscriptProviderOptions();
      
      // LLMã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’æ›´æ–°
      updateLlmIndicator();
    }

    // æ–‡å­—èµ·ã“ã—ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®é¸æŠè‚¢ã‚’æ›´æ–°
    function updateTranscriptProviderOptions() {
      const geminiKey = SecureStorage.getApiKey('gemini');
      const openaiKey = SecureStorage.getApiKey('openai');
      const select = document.getElementById('transcriptProvider');
      
      // é¸æŠè‚¢ã‚’æœ‰åŠ¹/ç„¡åŠ¹åŒ–
      select.querySelector('option[value="gemini"]').disabled = !geminiKey;
      select.querySelector('option[value="openai"]').disabled = !openaiKey;
      
      // æœ‰åŠ¹ãªãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’è‡ªå‹•é¸æŠ
      if (geminiKey) {
        select.value = 'gemini';
      } else if (openaiKey) {
        select.value = 'openai';
      }
    }

    // ä½¿ç”¨å¯èƒ½ãªLLMã‚’å–å¾—
    function getAvailableLlm() {
      const priority = SecureStorage.getOption('llmPriority', 'auto');
      const providers = ['claude', 'openai', 'gemini', 'groq']; // å„ªå…ˆé †ä½
      
      if (priority !== 'auto') {
        // æŒ‡å®šã•ã‚ŒãŸãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’å„ªå…ˆ
        if (SecureStorage.getApiKey(priority)) {
          return { provider: priority, model: SecureStorage.getModel(priority) || getDefaultModel(priority) };
        }
      }
      
      // è‡ªå‹•é¸æŠï¼šè¨­å®šã•ã‚Œã¦ã„ã‚‹APIã‚­ãƒ¼ã‚’å„ªå…ˆé †ä½ã§é¸æŠ
      for (const p of providers) {
        if (SecureStorage.getApiKey(p)) {
          return { provider: p, model: SecureStorage.getModel(p) || getDefaultModel(p) };
        }
      }
      
      return null; // ä½¿ç”¨å¯èƒ½ãªLLMãªã—
    }

    // LLMã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’æ›´æ–°
    function updateLlmIndicator() {
      const indicator = document.getElementById('llmIndicator');
      const llm = getAvailableLlm();
      
      if (llm) {
        const names = { gemini: 'Gemini', claude: 'Claude', openai: 'OpenAI', groq: 'Groq' };
        indicator.textContent = `ğŸ¤– ${names[llm.provider]}`;
        indicator.classList.remove('no-api');
      } else {
        indicator.textContent = 'âš ï¸ APIæœªè¨­å®š';
        indicator.classList.add('no-api');
      }
    }

    // =====================================
    // ãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡
    // =====================================
    function closeWelcome() {
      document.getElementById('welcomeModal').classList.remove('active');
    }

    function openSettings() {
      loadSavedSettings();
      document.getElementById('settingsModal').classList.add('active');
    }

    function closeSettings() {
      document.getElementById('settingsModal').classList.remove('active');
    }

    async function saveSettings() {
      const providers = ['gemini', 'claude', 'openai', 'groq'];
      
      // APIã‚­ãƒ¼ã‚’ä¿å­˜
      providers.forEach(p => {
        const key = document.getElementById(`${p}ApiKey`).value.trim();
        const model = document.getElementById(`${p}Model`).value;
        SecureStorage.setApiKey(p, key);
        SecureStorage.setModel(p, model);
      });

      // ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä¿å­˜
      SecureStorage.setOption('clearOnClose', document.getElementById('clearOnClose').checked);
      SecureStorage.setOption('costAlertEnabled', document.getElementById('costAlertEnabled').checked);
      SecureStorage.setOption('costLimit', parseInt(document.getElementById('costLimit').value) || 100);
      SecureStorage.setOption('llmPriority', document.getElementById('llmPriority').value);

      // æ–‡å­—èµ·ã“ã—ç”¨APIãŒå°‘ãªãã¨ã‚‚1ã¤è¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
      const geminiKey = SecureStorage.getApiKey('gemini');
      const openaiKey = SecureStorage.getApiKey('openai');
      
      if (!geminiKey && !openaiKey) {
        alert('æ–‡å­—èµ·ã“ã—ç”¨ã«ã€Gemini APIã¾ãŸã¯OpenAI APIã®ã„ãšã‚Œã‹ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚');
        return;
      }

      // è¨­å®šã•ã‚ŒãŸAPIã‚­ãƒ¼ã‚’æ¤œè¨¼
      if (geminiKey) {
        const isValid = await validateApiKey('gemini', geminiKey);
        if (!isValid) {
          alert('Gemini APIã‚­ãƒ¼ãŒç„¡åŠ¹ã§ã™ã€‚æ­£ã—ã„ã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
          return;
        }
      }
      
      if (openaiKey) {
        const isValid = await validateApiKey('openai', openaiKey);
        if (!isValid) {
          alert('OpenAI APIã‚­ãƒ¼ãŒç„¡åŠ¹ã§ã™ã€‚æ­£ã—ã„ã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
          return;
        }
      }

      // UIæ›´æ–°
      updateTranscriptProviderOptions();
      updateLlmIndicator();

      alert('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
      closeSettings();
    }

    // APIã‚­ãƒ¼ã®æ¤œè¨¼
    async function validateApiKey(provider, key) {
      const statusEl = document.getElementById(`${provider}-status`);
      if (!statusEl) return true;

      statusEl.style.display = 'inline-flex';
      statusEl.className = 'validation-status validation-pending';
      statusEl.textContent = 'æ¤œè¨¼ä¸­...';

      try {
        let isValid = false;

        if (provider === 'gemini') {
          // Gemini APIã®ç°¡æ˜“æ¤œè¨¼
          const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${key}`);
          isValid = res.ok;
        } else if (provider === 'openai') {
          const res = await fetch('https://api.openai.com/v1/models', {
            headers: { 'Authorization': `Bearer ${key}` }
          });
          isValid = res.ok;
        } else if (provider === 'groq') {
          const res = await fetch('https://api.groq.com/openai/v1/models', {
            headers: { 'Authorization': `Bearer ${key}` }
          });
          isValid = res.ok;
        } else {
          // Claude ã¯ç›´æ¥æ¤œè¨¼ãŒé›£ã—ã„ã®ã§ã‚¹ã‚­ãƒƒãƒ—
          isValid = true;
        }

        statusEl.className = isValid ? 'validation-status validation-success' : 'validation-status validation-error';
        statusEl.textContent = isValid ? 'âœ“ æœ‰åŠ¹' : 'âœ— ç„¡åŠ¹';
        return isValid;
      } catch (e) {
        statusEl.className = 'validation-status validation-error';
        statusEl.textContent = 'âœ— ã‚¨ãƒ©ãƒ¼';
        return false;
      }
    }

    // è¨­å®šã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
    function exportSettings() {
      const password = prompt('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆç”¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã—ã¦ãã ã•ã„ï¼ˆã‚¤ãƒ³ãƒãƒ¼ãƒˆæ™‚ã«å¿…è¦ï¼‰:');
      if (!password) return;

      const encrypted = SecureStorage.exportAll(password);
      const blob = new Blob([JSON.stringify({ data: encrypted, v: 1 })], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `ai-meeting-settings-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);

      alert('è¨­å®šã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸã€‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯å®‰å…¨ã«ä¿ç®¡ã—ã¦ãã ã•ã„ã€‚');
    }

    // è¨­å®šã‚¤ãƒ³ãƒãƒ¼ãƒˆ
    function importSettings(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const json = JSON.parse(e.target.result);
          const password = prompt('ã‚¤ãƒ³ãƒãƒ¼ãƒˆç”¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
          if (!password) return;

          const success = SecureStorage.importAll(json.data, password);
          if (success) {
            alert('è¨­å®šã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ');
            loadSavedSettings();
          } else {
            alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
          }
        } catch (err) {
          alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      };
      reader.readAsText(file);
      event.target.value = '';
    }

    // å…¨è¨­å®šå‰Šé™¤
    function clearAllSettings() {
      if (confirm('ã™ã¹ã¦ã®è¨­å®šï¼ˆAPIã‚­ãƒ¼å«ã‚€ï¼‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
        SecureStorage.clearAll();
        loadSavedSettings();
        alert('è¨­å®šã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
      }
    }

    // =====================================
    // éŒ²éŸ³æ©Ÿèƒ½
    // =====================================
    async function toggleRecording() {
      if (isRecording) {
        stopRecording();
      } else {
        await startRecording();
      }
    }

    async function startRecording() {
      const provider = document.getElementById('transcriptProvider').value;
      const apiKey = SecureStorage.getApiKey(provider);
      
      if (!apiKey) {
        alert(`${provider === 'gemini' ? 'Gemini' : 'OpenAI'} APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„`);
        openSettings();
        return;
      }

      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
        audioChunks = [];

        mediaRecorder.ondataavailable = (e) => {
          if (e.data.size > 0) {
            audioChunks.push(e.data);
          }
        };

        mediaRecorder.start();
        isRecording = true;
        updateUI();

        // å®šæœŸçš„ã«æ–‡å­—èµ·ã“ã—
        const interval = parseInt(document.getElementById('transcriptInterval').value) * 1000;
        transcriptIntervalId = setInterval(processAudioChunk, interval);

      } catch (err) {
        console.error('éŒ²éŸ³é–‹å§‹ã‚¨ãƒ©ãƒ¼:', err);
        alert('ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    function stopRecording() {
      if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
        mediaRecorder.stream.getTracks().forEach(track => track.stop());
      }
      if (transcriptIntervalId) {
        clearInterval(transcriptIntervalId);
        transcriptIntervalId = null;
      }
      
      // æ®‹ã‚Šã®éŸ³å£°ã‚’å‡¦ç†
      if (audioChunks.length > 0) {
        processAudioChunk();
      }

      isRecording = false;
      updateUI();
    }

    async function processAudioChunk() {
      if (audioChunks.length === 0) return;

      const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
      audioChunks = [];

      // æ–°ã—ã„éŒ²éŸ³ã‚’é–‹å§‹
      if (isRecording && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
        mediaRecorder.start();
      }

      try {
        const provider = document.getElementById('transcriptProvider').value;
        const text = provider === 'openai' 
          ? await transcribeWithWhisper(audioBlob)
          : await transcribeWithGemini(audioBlob);
          
        if (text && text.trim()) {
          const timestamp = new Date().toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
          fullTranscript += `[${timestamp}] ${text}\n`;
          document.getElementById('transcriptText').textContent = fullTranscript;
          
          // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
          const body = document.getElementById('transcriptBody');
          body.scrollTop = body.scrollHeight;
        }
      } catch (err) {
        console.error('æ–‡å­—èµ·ã“ã—ã‚¨ãƒ©ãƒ¼:', err);
      }
    }

    async function transcribeWithGemini(audioBlob) {
      const geminiKey = SecureStorage.getApiKey('gemini');
      const base64Audio = await blobToBase64(audioBlob);

      const response = await fetch(
        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${geminiKey}`,
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{
              parts: [
                { text: 'ä»¥ä¸‹ã®éŸ³å£°ã‚’æ—¥æœ¬èªã§æ–‡å­—èµ·ã“ã—ã—ã¦ãã ã•ã„ã€‚è©±è€…ãŒè¤‡æ•°ã„ã‚‹å ´åˆã¯åŒºåˆ¥ã—ã¦ãã ã•ã„ã€‚éŸ³å£°ãŒãªã„å ´åˆã‚„èãå–ã‚Œãªã„å ´åˆã¯ã€Œï¼ˆéŸ³å£°ãªã—ï¼‰ã€ã¨è¿”ã—ã¦ãã ã•ã„ã€‚' },
                { inline_data: { mime_type: 'audio/webm', data: base64Audio } }
              ]
            }]
          })
        }
      );

      if (!response.ok) {
        throw new Error(`Gemini API error: ${response.status}`);
      }

      const data = await response.json();
      const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
      
      // ã‚³ã‚¹ãƒˆè¨ˆç®—
      const estimatedSeconds = Math.max(audioBlob.size / 4000, 1);
      const audioCost = estimatedSeconds * PRICING.transcription.gemini.perSecond;
      
      costs.transcript.duration += estimatedSeconds;
      costs.transcript.calls += 1;
      costs.transcript.byProvider.gemini += audioCost;
      costs.transcript.total += audioCost;
      
      updateCosts();
      checkCostAlert();

      return text.replace('ï¼ˆéŸ³å£°ãªã—ï¼‰', '').trim();
    }

    async function transcribeWithWhisper(audioBlob) {
      const openaiKey = SecureStorage.getApiKey('openai');
      
      // FormDataã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é€ä¿¡
      const formData = new FormData();
      formData.append('file', audioBlob, 'audio.webm');
      formData.append('model', 'whisper-1');
      formData.append('language', 'ja');

      const response = await fetch('https://api.openai.com/v1/audio/transcriptions', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${openaiKey}`
        },
        body: formData
      });

      if (!response.ok) {
        throw new Error(`Whisper API error: ${response.status}`);
      }

      const data = await response.json();
      const text = data.text || '';
      
      // ã‚³ã‚¹ãƒˆè¨ˆç®—ï¼ˆWhisperã¯åˆ†å˜ä½èª²é‡‘ï¼‰
      const estimatedSeconds = Math.max(audioBlob.size / 4000, 1);
      const estimatedMinutes = estimatedSeconds / 60;
      const audioCost = estimatedMinutes * PRICING.transcription.openai.perMinute;
      
      costs.transcript.duration += estimatedSeconds;
      costs.transcript.calls += 1;
      costs.transcript.byProvider.openai += audioCost;
      costs.transcript.total += audioCost;
      
      updateCosts();
      checkCostAlert();

      return text.trim();
    }

    function blobToBase64(blob) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => {
          const base64 = reader.result.split(',')[1];
          resolve(base64);
        };
        reader.onerror = reject;
        reader.readAsDataURL(blob);
      });
    }

    // =====================================
    // AIè³ªå•æ©Ÿèƒ½
    // =====================================
    async function askAI(type) {
      const transcript = fullTranscript.trim();
      if (!transcript) {
        alert('æ–‡å­—èµ·ã“ã—ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }

      // é¸æŠãƒ†ã‚­ã‚¹ãƒˆãŒã‚ã‚Œã°ã€ãã‚Œã‚’å¯¾è±¡ã«ã™ã‚‹
      const selection = window.getSelection().toString().trim();
      const targetText = selection || transcript;

      // ä½¿ç”¨å¯èƒ½ãªLLMã‚’è‡ªå‹•é¸æŠ
      const llm = getAvailableLlm();
      
      if (!llm) {
        alert('LLMç”¨ã®APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\nè¨­å®šç”»é¢ã§APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        openSettings();
        return;
      }

      const provider = llm.provider;

      let prompt = '';
      let customQ = '';

      switch(type) {
        case 'summary':
          prompt = `ä»¥ä¸‹ã®ä¼šè­°å†…å®¹ã‚’ç°¡æ½”ã«è¦ç´„ã—ã¦ãã ã•ã„ã€‚é‡è¦ãªãƒã‚¤ãƒ³ãƒˆã‚’ç®‡æ¡æ›¸ãã§ã¾ã¨ã‚ã¦ãã ã•ã„ã€‚\n\n${targetText}`;
          break;
        case 'opinion':
          prompt = `ä»¥ä¸‹ã®ä¼šè­°å†…å®¹ã«ã¤ã„ã¦ã€AIã¨ã—ã¦ã®æ„è¦‹ã‚„åˆ†æã‚’è¿°ã¹ã¦ãã ã•ã„ã€‚æ”¹å–„ç‚¹ã‚„æ³¨æ„ç‚¹ãŒã‚ã‚Œã°æŒ‡æ‘˜ã—ã¦ãã ã•ã„ã€‚\n\n${targetText}`;
          break;
        case 'idea':
          prompt = `ä»¥ä¸‹ã®ä¼šè­°å†…å®¹ã‚’è¸ã¾ãˆã¦ã€æ–°ã—ã„ã‚¢ã‚¤ãƒ‡ã‚¢ã‚„ææ¡ˆã‚’3ã¤æŒ™ã’ã¦ãã ã•ã„ã€‚\n\n${targetText}`;
          break;
        case 'custom':
          customQ = document.getElementById('customQuestion').value.trim();
          if (!customQ) {
            alert('è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
          }
          prompt = `ä»¥ä¸‹ã®ä¼šè­°å†…å®¹ã«ã¤ã„ã¦è³ªå•ã«ç­”ãˆã¦ãã ã•ã„ã€‚\n\nã€ä¼šè­°å†…å®¹ã€‘\n${targetText}\n\nã€è³ªå•ã€‘\n${customQ}`;
          document.getElementById('customQuestion').value = '';
          break;
      }

      // ã‚¿ãƒ–ã‚’åˆ‡ã‚Šæ›¿ãˆ
      switchTab(type);

      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
      if (type === 'custom') {
        const qaHistory = document.getElementById('qa-history');
        qaHistory.innerHTML += `<div class="qa-item"><div class="qa-question">Q: ${customQ}</div><div class="qa-answer"><span class="loading"></span> å›ç­”ã‚’ç”Ÿæˆä¸­...</div></div>`;
      } else {
        document.getElementById(`response-${type}`).innerHTML = '<span class="loading"></span> å›ç­”ã‚’ç”Ÿæˆä¸­...';
      }

      try {
        const response = await callLLM(provider, prompt);
        
        if (type === 'custom') {
          // Q&Aå±¥æ­´ã‚’æ›´æ–°
          const qaItems = document.querySelectorAll('#qa-history .qa-item');
          const lastItem = qaItems[qaItems.length - 1];
          lastItem.querySelector('.qa-answer').textContent = response;
          aiResponses.custom.push({ q: customQ, a: response });
        } else if (type === 'summary') {
          // è¦ç´„ã¯ä¸Šæ›¸ã
          document.getElementById(`response-${type}`).textContent = response;
          aiResponses[type] = response;
        } else {
          // æ„è¦‹ãƒ»ã‚¢ã‚¤ãƒ‡ã‚¢ã¯è“„ç©
          const timestamp = new Date().toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
          const newResponse = `ã€${timestamp}ã€‘\n${response}`;
          aiResponses[type] = aiResponses[type] ? `${aiResponses[type]}\n\n---\n\n${newResponse}` : newResponse;
          document.getElementById(`response-${type}`).textContent = aiResponses[type];
        }
      } catch (err) {
        console.error('AIå‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼:', err);
        const errorMsg = `ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${err.message}`;
        if (type === 'custom') {
          const qaItems = document.querySelectorAll('#qa-history .qa-item');
          const lastItem = qaItems[qaItems.length - 1];
          lastItem.querySelector('.qa-answer').textContent = errorMsg;
        } else {
          document.getElementById(`response-${type}`).textContent = errorMsg;
        }
      }
    }

    async function callLLM(provider, prompt) {
      const apiKey = SecureStorage.getApiKey(provider);
      const model = SecureStorage.getModel(provider) || getDefaultModel(provider);

      let response, data, text;
      let inputTokens = 0, outputTokens = 0;

      switch(provider) {
        case 'gemini':
          response = await fetch(
            `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`,
            {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                contents: [{ parts: [{ text: prompt }] }]
              })
            }
          );
          data = await response.json();
          if (!response.ok) throw new Error(data.error?.message || 'Gemini API error');
          text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
          inputTokens = data.usageMetadata?.promptTokenCount || Math.ceil(prompt.length / 4);
          outputTokens = data.usageMetadata?.candidatesTokenCount || Math.ceil(text.length / 4);
          break;

        case 'claude':
          response = await fetch('https://api.anthropic.com/v1/messages', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-api-key': apiKey,
              'anthropic-version': '2023-06-01',
              'anthropic-dangerous-direct-browser-access': 'true'
            },
            body: JSON.stringify({
              model: model,
              max_tokens: 2048,
              messages: [{ role: 'user', content: prompt }]
            })
          });
          data = await response.json();
          if (!response.ok) throw new Error(data.error?.message || 'Claude API error');
          text = data.content?.[0]?.text || '';
          inputTokens = data.usage?.input_tokens || Math.ceil(prompt.length / 4);
          outputTokens = data.usage?.output_tokens || Math.ceil(text.length / 4);
          break;

        case 'openai':
          response = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${apiKey}`
            },
            body: JSON.stringify({
              model: model,
              messages: [{ role: 'user', content: prompt }]
            })
          });
          data = await response.json();
          if (!response.ok) throw new Error(data.error?.message || 'OpenAI API error');
          text = data.choices?.[0]?.message?.content || '';
          inputTokens = data.usage?.prompt_tokens || Math.ceil(prompt.length / 4);
          outputTokens = data.usage?.completion_tokens || Math.ceil(text.length / 4);
          break;

        case 'groq':
          response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${apiKey}`
            },
            body: JSON.stringify({
              model: model,
              messages: [{ role: 'user', content: prompt }]
            })
          });
          data = await response.json();
          if (!response.ok) throw new Error(data.error?.message || 'Groq API error');
          text = data.choices?.[0]?.message?.content || '';
          inputTokens = data.usage?.prompt_tokens || Math.ceil(prompt.length / 4);
          outputTokens = data.usage?.completion_tokens || Math.ceil(text.length / 4);
          break;
      }

      // ã‚³ã‚¹ãƒˆè¨ˆç®—ï¼ˆè©³ç´°ç‰ˆï¼‰
      const pricing = PRICING[provider]?.[model] || { input: 1, output: 3 };
      const cost = ((inputTokens * pricing.input + outputTokens * pricing.output) / 1000000) * PRICING.yenPerDollar;
      
      costs.llm.inputTokens += inputTokens;
      costs.llm.outputTokens += outputTokens;
      costs.llm.calls += 1;
      costs.llm.byProvider[provider] += cost;
      costs.llm.total += cost;

      updateCosts();
      checkCostAlert();
      
      return text;
    }

    function getDefaultModel(provider) {
      const defaults = {
        gemini: 'gemini-2.0-flash-exp',
        claude: 'claude-sonnet-4-20250514',
        openai: 'gpt-4o',
        groq: 'llama-3.1-70b-versatile'
      };
      return defaults[provider];
    }

    // =====================================
    // UIæ›´æ–°
    // =====================================
    function updateUI() {
      const btn = document.getElementById('recordBtn');
      const badge = document.getElementById('statusBadge');

      if (isRecording) {
        btn.textContent = 'â¹ éŒ²éŸ³åœæ­¢';
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-danger');
        badge.textContent = 'ğŸ”´ éŒ²éŸ³ä¸­';
        badge.classList.remove('status-ready');
        badge.classList.add('status-recording');
      } else {
        btn.textContent = 'ğŸ¤ éŒ²éŸ³é–‹å§‹';
        btn.classList.remove('btn-danger');
        btn.classList.add('btn-primary');
        badge.textContent = 'â¸ å¾…æ©Ÿä¸­';
        badge.classList.remove('status-recording');
        badge.classList.add('status-ready');
      }
    }

    function updateCosts() {
      const total = costs.transcript.total + costs.llm.total;
      
      // æ–‡å­—èµ·ã“ã—ã‚³ã‚¹ãƒˆ
      document.getElementById('transcriptCostTotal').textContent = formatCost(costs.transcript.total);
      document.getElementById('transcriptDuration').textContent = formatDuration(costs.transcript.duration);
      document.getElementById('transcriptCalls').textContent = `${costs.transcript.calls}å›`;
      document.getElementById('geminiTranscriptCost').textContent = formatCost(costs.transcript.byProvider.gemini);
      document.getElementById('openaiTranscriptCost').textContent = formatCost(costs.transcript.byProvider.openai);
      
      // æ–‡å­—èµ·ã“ã—ã‚³ã‚¹ãƒˆãƒãƒƒã‚¸
      const transcriptBadge = document.getElementById('transcriptCostBadge');
      updateCostBadge(transcriptBadge, costs.transcript.total);
      
      // LLMã‚³ã‚¹ãƒˆ
      document.getElementById('llmCostTotal').textContent = formatCost(costs.llm.total);
      document.getElementById('llmInputTokens').textContent = formatNumber(costs.llm.inputTokens);
      document.getElementById('llmOutputTokens').textContent = formatNumber(costs.llm.outputTokens);
      document.getElementById('llmCalls').textContent = `${costs.llm.calls}å›`;
      
      // ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼åˆ¥
      document.getElementById('geminiLlmCost').textContent = formatCost(costs.llm.byProvider.gemini);
      document.getElementById('claudeCost').textContent = formatCost(costs.llm.byProvider.claude);
      document.getElementById('openaiCost').textContent = formatCost(costs.llm.byProvider.openai);
      document.getElementById('groqCost').textContent = formatCost(costs.llm.byProvider.groq);
      
      // LLMã‚³ã‚¹ãƒˆãƒãƒƒã‚¸
      const llmBadge = document.getElementById('llmCostBadge');
      updateCostBadge(llmBadge, costs.llm.total);
      
      // åˆè¨ˆ
      document.getElementById('totalCost').textContent = formatCost(total);
    }

    function formatCost(yen) {
      if (yen < 1) {
        return `Â¥${yen.toFixed(2)}`;
      }
      return `Â¥${Math.round(yen).toLocaleString()}`;
    }

    function formatDuration(seconds) {
      if (seconds < 60) {
        return `${Math.round(seconds)}ç§’`;
      }
      const mins = Math.floor(seconds / 60);
      const secs = Math.round(seconds % 60);
      return `${mins}åˆ†${secs}ç§’`;
    }

    function formatNumber(num) {
      return num.toLocaleString();
    }

    function updateCostBadge(badge, cost) {
      badge.classList.remove('cost-badge-low', 'cost-badge-medium', 'cost-badge-high');
      if (cost < 10) {
        badge.classList.add('cost-badge-low');
        badge.textContent = 'ä½';
      } else if (cost < 50) {
        badge.classList.add('cost-badge-medium');
        badge.textContent = 'ä¸­';
      } else {
        badge.classList.add('cost-badge-high');
        badge.textContent = 'é«˜';
      }
    }

    function toggleCostDetails(type) {
      const details = document.getElementById(`${type}CostDetails`);
      details.classList.toggle('show');
    }

    function checkCostAlert() {
      const alertEnabled = SecureStorage.getOption('costAlertEnabled', true);
      const costLimit = SecureStorage.getOption('costLimit', 100);
      
      if (!alertEnabled || costLimit <= 0) return;
      
      const total = costs.transcript.total + costs.llm.total;
      const threshold = costLimit * 0.8;
      
      const warningEl = document.getElementById('costWarning');
      if (total >= threshold) {
        warningEl.style.display = 'block';
        warningEl.textContent = `âš ï¸ ä¸Šé™ï¼ˆÂ¥${costLimit}ï¼‰ã®${Math.round(total / costLimit * 100)}%ã«é”ã—ã¦ã„ã¾ã™`;
        
        if (total >= costLimit) {
          warningEl.textContent = `ğŸš« ä¸Šé™ï¼ˆÂ¥${costLimit}ï¼‰ã‚’è¶…ãˆã¾ã—ãŸï¼`;
          warningEl.style.background = '#fee2e2';
          warningEl.style.borderColor = '#fca5a5';
          warningEl.style.color = '#991b1b';
        }
      } else {
        warningEl.style.display = 'none';
      }
    }

    function switchTab(tabName) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.querySelector(`.tab[data-tab="${tabName}"]`).classList.add('active');
      document.getElementById(`tab-${tabName}`).classList.add('active');
    }

    function clearTranscript() {
      if (confirm('æ–‡å­—èµ·ã“ã—ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) {
        fullTranscript = '';
        document.getElementById('transcriptText').textContent = '';
      }
    }

    // =====================================
    // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
    // =====================================
    function openExportModal() {
      const preview = generateExportMarkdown();
      document.getElementById('exportPreview').textContent = preview;
      document.getElementById('exportModal').classList.add('active');
    }

    function closeExportModal() {
      document.getElementById('exportModal').classList.remove('active');
    }

    function generateExportMarkdown() {
      const now = new Date().toLocaleString('ja-JP');
      const total = costs.transcript.total + costs.llm.total;
      
      let md = `# ä¼šè­°è¨˜éŒ²\n\n`;
      md += `**æ—¥æ™‚:** ${now}\n\n`;
      md += `---\n\n`;
      md += `## ğŸ“ æ–‡å­—èµ·ã“ã—\n\n`;
      md += fullTranscript || 'ï¼ˆãªã—ï¼‰';
      md += `\n\n---\n\n`;
      
      if (aiResponses.summary) {
        md += `## ğŸ“‹ è¦ç´„\n\n${aiResponses.summary}\n\n`;
      }
      if (aiResponses.opinion) {
        md += `## ğŸ’­ æ„è¦‹\n\n${aiResponses.opinion}\n\n`;
      }
      if (aiResponses.idea) {
        md += `## ğŸ’¡ ã‚¢ã‚¤ãƒ‡ã‚¢\n\n${aiResponses.idea}\n\n`;
      }
      if (aiResponses.custom.length > 0) {
        md += `## â“ Q&A\n\n`;
        aiResponses.custom.forEach((qa, i) => {
          md += `### Q${i+1}: ${qa.q}\n\n${qa.a}\n\n`;
        });
      }

      md += `---\n\n`;
      md += `## ğŸ’° ã‚³ã‚¹ãƒˆè©³ç´°\n\n`;
      md += `### æ–‡å­—èµ·ã“ã—\n`;
      md += `- å‡¦ç†æ™‚é–“: ${formatDuration(costs.transcript.duration)}\n`;
      md += `- APIå‘¼ã³å‡ºã—: ${costs.transcript.calls}å›\n`;
      md += `- Gemini Audio: ${formatCost(costs.transcript.byProvider.gemini)}\n`;
      md += `- OpenAI Whisper: ${formatCost(costs.transcript.byProvider.openai)}\n`;
      md += `- å°è¨ˆ: ${formatCost(costs.transcript.total)}\n\n`;
      md += `### LLMï¼ˆAIå›ç­”ï¼‰\n`;
      md += `- å…¥åŠ›ãƒˆãƒ¼ã‚¯ãƒ³: ${formatNumber(costs.llm.inputTokens)}\n`;
      md += `- å‡ºåŠ›ãƒˆãƒ¼ã‚¯ãƒ³: ${formatNumber(costs.llm.outputTokens)}\n`;
      md += `- APIå‘¼ã³å‡ºã—: ${costs.llm.calls}å›\n`;
      md += `- Gemini: ${formatCost(costs.llm.byProvider.gemini)}\n`;
      md += `- Claude: ${formatCost(costs.llm.byProvider.claude)}\n`;
      md += `- OpenAI: ${formatCost(costs.llm.byProvider.openai)}\n`;
      md += `- Groq: ${formatCost(costs.llm.byProvider.groq)}\n`;
      md += `- å°è¨ˆ: ${formatCost(costs.llm.total)}\n\n`;
      md += `### åˆè¨ˆ\n`;
      md += `**${formatCost(total)}**\n\n`;
      md += `---\n`;
      md += `*ã“ã®é‡‘é¡ã¯æ¦‚ç®—ã§ã™ã€‚å®Ÿéš›ã®è«‹æ±‚é¡ã¨ã¯ç•°ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚*\n`;
      
      return md;
    }

    function downloadExport() {
      const md = generateExportMarkdown();
      const blob = new Blob([md], { type: 'text/markdown' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `meeting-${new Date().toISOString().split('T')[0]}.md`;
      a.click();
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
